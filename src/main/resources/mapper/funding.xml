<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tenco.indiepicter.funding.FundingRepository">


    <select id="findAllByGenre" resultMap="moviesByGenreDTOResultMap">
            select ft.movie_id, mt.thumbnail, ft.present_price * 100 / ft.target_price funding_rate, mt.movie_name, mt.synopsis, mt.production from funding_tb ft join movie_tb mt on ft.movie_id = mt.id where genre = #{genre}
                limit #{pageSize} offset #{offset}
    </select>

    <resultMap id="moviesByGenreDTOResultMap" type="com.tenco.indiepicter.funding.response.MoviesByGenreDTO">
        <result property="movieId" column="movie_id"/>
        <result property="movieThumbnail" column="thumbnail"/>
        <result property="fundingRate" column="funding_rate"/>
        <result property="movieName" column="movie_name"/>
        <result property="synopsis" column="synopsis"/>
        <result property="production" column="production"/>
    </resultMap>

    <select id="findAllByOnAir" resultMap="OnAirMovieDTOResultMap">
        select mt.thumbnail, mt.movie_name, ft.present_price * 100 / ft.target_price funding_rate, mt.production from funding_tb ft join movie_tb mt on ft.movie_id = mt.id where curdate() BETWEEN mt.online_release_date AND mt.online_end_date limit 4;
    </select>

    <resultMap id="OnAirMovieDTOResultMap" type="com.tenco.indiepicter.funding.response.OnAirMovieDTO">
        <result property="movieThumbnail" column="thumbnail"/>
        <result property="movieName" column="movie_name"/>
        <result property="fundingRate" column="funding_rate"/>
        <result property="production" column="production"/>
    </resultMap>

    <select id="findAllByOnAirAndRanking" resultMap="OnAirMovieRankingDTOResultMap">
        select mt.thumbnail, mt.movie_name, ft.present_price * 100 / ft.target_price funding_rate, mt.production from funding_tb ft join movie_tb mt on ft.movie_id = mt.id where curdate() BETWEEN mt.online_release_date AND mt.online_end_date order by ft.present_price desc limit 3;
    </select>

    <resultMap id="OnAirMovieRankingDTOResultMap" type="com.tenco.indiepicter.funding.response.OnAirMovieRankingDTO">
        <result property="movieThumbnail" column="thumbnail"/>
        <result property="movieName" column="movie_name"/>
        <result property="fundingRate" column="funding_rate"/>
        <result property="production" column="production"/>
    </resultMap>

    <select id="findByFundingIdAboutDetailfunding" resultMap="FundingDetailDTOResultOMap">
        select ft.id, mt.thumbnail, mt.genre, (ft.present_price * 100 / ft.target_price) funding_rate, (ft.end_date - ft.release_date) rest_period,
               ft.present_price, ft.people_count, mt.movie_name, mt.synopsis, ft.price_per_onetime, concat(ft.release_date, ' ~ ', ft.end_date) funding_period, mt.d_day, mt.directing_intension,
               mt.director_careers, mt.director_awards_film, movie_pic, mst.director as mdirector, mst.filming, mst.art, mst.sound, mst.clothes, mst.script, mst.lighting, mst.editing, mst.music,
               mst.sound, CASE
                                                                                                                                                                                                     WHEN curdate() >= mt.online_release_date THEN 'true'
                                                                                                                                                                                                     ELSE 'false' END open
        from funding_tb ft join movie_tb mt on ft.movie_id = mt.id join movie_photo_tb mpt on mt.id = mpt.movie_id join movie_staff_tb mst on mt.id = mst.movie_id
        where curdate() BETWEEN mt.online_release_date AND mt.online_end_date AND ft.id = #{fundingId};
    </select>

    <resultMap id="FundingDetailDTOResultOMap" type="com.tenco.indiepicter.funding.response.FundingDetailDTO">
        <result property="fundingId" column="id"/>
        <result property="movieThumbnail" column="thumbnail"/>
        <result property="isOpen" column="open"/>
        <result property="genre" column="genre"/>
        <result property="fundingRate" column="funding_rate"/>
        <result property="restPeriod" column="rest_period"/>
        <result property="fundingPresentPrice" column="present_price"/>
        <result property="peopleCount" column="people_count"/>
        <result property="movieName" column="movie_name"/>
        <result property="synopsis" column="synopsis"/>
        <result property="fundingProductPrice" column="price_per_onetime"/>
        <result property="fundingPeriod" column="funding_period"/>
        <result property="dDay" column="d_day"/>
        <result property="directingIntension" column="directing_intension"/>
        <result property="directorCareers" column="director_careers"/>
        <result property="directorAwardsFilm" column="director_awards_film"/>
        <result property="director" column="mdirector"/>
        <result property="filming" column="filming"/>
        <result property="art" column="art"/>
        <result property="sound" column="sound"/>
        <result property="clothes" column="clothes"/>
        <result property="script" column="script"/>
        <result property="lighting" column="lighting"/>
        <result property="editing" column="editing"/>
        <result property="music" column="music"/>
        <collection property="moviePhotos" ofType="java.lang.String" javaType="java.util.List">
            <result property="element" column="movie_pic"/>
        </collection>
    </resultMap>

    <select id="findByFundingIdAboutOfflineMovie" resultMap="OfflineMovieDetailDTOResultOMap">
        select ft.id, mt.thumbnail, mt.genre, (ft.present_price * 100 / ft.target_price) funding_rate, (ft.end_date - ft.release_date) rest_period,
               ft.present_price, ft.people_count, mt.movie_name, mt.synopsis, ft.price_per_onetime, concat(ft.release_date, ' ~ ', ft.end_date) funding_period, mt.d_day, mt.directing_intension,
               mt.director_careers, mt.director_awards_film, movie_pic, mst.director as mdirector, mst.filming, mst.art, mst.sound, mst.clothes, mst.script, mst.lighting, mst.editing, mst.music,
               mst.sound, concat(mt.offline_release_date, ' ~ ' , mt.offline_end_date) offline_running_period, CASE
                                                                                                                                                                                                                  WHEN curdate() >= mt.online_release_date THEN 'true'
                                                                                                                                                                                                                  ELSE 'false' END open
        from funding_tb ft join movie_tb mt on ft.movie_id = mt.id join movie_photo_tb mpt on mt.id = mpt.movie_id join movie_staff_tb mst on mt.id = mst.movie_id
        where curdate() BETWEEN mt.online_release_date AND mt.online_end_date AND ft.id = #{fundingId};
    </select>

    <resultMap id="OfflineMovieDetailDTOResultOMap" type="com.tenco.indiepicter.funding.response.OfflineMovieDetailDTO">
        <result property="fundingId" column="id"/>
        <result property="movieThumbnail" column="thumbnail"/>
        <result property="isOpen" column="open"/>
        <result property="genre" column="genre"/>
        <result property="fundingRate" column="funding_rate"/>
        <result property="restPeriod" column="rest_period"/>
        <result property="fundingPresentPrice" column="present_price"/>
        <result property="peopleCount" column="people_count"/>
        <result property="movieName" column="movie_name"/>
        <result property="synopsis" column="synopsis"/>
        <result property="fundingProductPrice" column="price_per_onetime"/>
        <result property="fundingPeriod" column="funding_period"/>
        <result property="dDay" column="d_day"/>
        <result property="offlineRunningPeriod" column="offline_running_period"/>
        <result property="directingIntension" column="directing_intension"/>
        <result property="directorCareers" column="director_careers"/>
        <result property="directorAwardsFilm" column="director_awards_film"/>
        <result property="director" column="mdirector"/>
        <result property="filming" column="filming"/>
        <result property="art" column="art"/>
        <result property="sound" column="sound"/>
        <result property="clothes" column="clothes"/>
        <result property="script" column="script"/>
        <result property="lighting" column="lighting"/>
        <result property="editing" column="editing"/>
        <result property="music" column="music"/>
        <collection property="moviePhotos" ofType="java.lang.String" javaType="java.util.List">
            <result property="element" column="movie_pic"/>
        </collection>

    </resultMap>

    <select id="findByMovieId" resultMap="findByFundingIdDTOResultMap">
        select id from funding_tb where movie_id = #{movieId};
    </select>
    <resultMap id="findByFundingIdDTOResultMap" type="com.tenco.indiepicter.funding.response.FindByFundingIdDTO">
        <result property="fundingId" column="id"/>
    </resultMap>


</mapper>