<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"

"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tenco.indiepicter.payment.PaymentRepository">

	<!-- 결제 정보 등록 -->
	<insert id="insert">
		insert into payment_tb(total_price, discount_price, final_price, paymented_at, payment_type_id, order_id)
		values (#{totalPrice}, #{discountPrice}, #{finalPrice}, now(), #{paymentTypeId}, #{orderId})
	</insert>

	<!-- 결제 정보 삭제 -->
	<delete id="deleteById">
		delete from payment_tb where id = #{paymentId}
	</delete>

	<!-- 나의 온라인 펀딩 내역 -->
	<select id="findByOnlinePaymentId" resultMap="MyPaymentOnlineDTOResultMap">
		select
			o.funding_id, m.thumbnail, m.movie_name, m.director, f.present_price, p.final_price, f.target_price, p.paymented_at, o.reservation_id, r.reservation_code, f.movie_id,
			o.id as order_id, p.id as payment_id
		from reservation_tb as r
				 inner join order_tb as o
							on r.id = o.reservation_id
				 inner join payment_tb as p
							on p.order_id = o.id
				 inner join funding_tb as f
							on f.id = o.funding_id
				 inner join movie_tb as m
							on m.id = f.movie_id
		where r.user_id = #{id} and r.seat_id is null;
	</select>
	<resultMap id="MyPaymentOnlineDTOResultMap" type="com.tenco.indiepicter.payment.response.MyOnlinePaymentDTO">
		<result property="thumbnail" column="thumbnail"/>
		<result property="movieId" column="movie_id"/>
		<result property="movieName" column="movie_name"/>
		<result property="fundingId" column="funding_id"/>
		<result property="director" column="director"/>
		<result property="presentPrice" column="present_price"/>
		<result property="synopsis" column="synopsis"/>
		<result property="targetPrice" column="target_price"/>
		<result property="finalPrice" column="final_price"/>
		<result property="reservationId" column="reservation_id"/>
		<result property="reservationCode" column="reservation_code"/>
		<result property="orderId" column="order_id"/>
		<result property="paymentId" column="payment_id"/>
		<result property="paymentedAt" column="paymented_at"/>
	</resultMap> 
	
	<!-- 나의 오프라인 펀딩 내역 -->
	<select id="findByOfflinePaymentId" resultMap="MyPaymentOfflineDTOResultMap">
		select
			o.funding_id, m.thumbnail, m.movie_name, m.director, f.present_price, p.final_price, f.target_price, p.paymented_at, o.reservation_id, r.reservation_code, f.movie_id,
			o.id as order_id, p.id as payment_id
		from reservation_tb as r
				 inner join order_tb as o
							on r.id = o.reservation_id
				 inner join payment_tb as p
							on p.order_id = o.id
				 inner join funding_tb as f
							on f.id = o.funding_id
				 inner join movie_tb as m
							on m.id = f.movie_id
		where r.user_id = #{id} and r.seat_id is not null;
	</select>
	<resultMap id="MyPaymentOfflineDTOResultMap" type="com.tenco.indiepicter.payment.response.MyOfflinePaymentDTO" >
		<result property="thumbnail" column="thumbnail"/>
		<result property="movieId" column="movie_id"/>
		<result property="movieName" column="movie_name"/>
		<result property="fundingId" column="funding_id"/>
		<result property="director" column="director"/>
		<result property="presentPrice" column="present_price"/>
		<result property="synopsis" column="synopsis"/>
		<result property="targetPrice" column="target_price"/>
		<result property="finalPrice" column="final_price"/>
		<result property="reservationId" column="reservation_id"/>
		<result property="reservationCode" column="reservation_code"/>
		<result property="orderId" column="order_id"/>
		<result property="paymentId" column="payment_id"/>
		<result property="paymentedAt" column="paymented_at"/>
	</resultMap>

</mapper>